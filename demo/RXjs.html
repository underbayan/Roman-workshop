<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

</head>
<body>
<input id="input" type="text"/>
<p id="results"></p>
<canvas id="tutorial" width="640" height="480"></canvas>
<h2>Geolocation + RxJS sample</h2>

<form>
    <select id="mapOpts">
        <option class="typeopt" value="roadmap">Road Map</option>
        <option class="typeopt" value="satellite">Satellite</option>
        <option class="typeopt" value="terrain">Terrain</option>
        <option class="typeopt" value="hybrid">Hybrid</option>
    </select>
</form>
<p>
    <img id="mapImage" />
</body>
<script src="./js/jquery.js"></script>
<script src="./js/rx.js"></script>
<script>

    var getCurrentPosition = function(opts) {
        opts = opts || {};
        var subject = new Rx.AsyncSubject();

        // Our callbacks will just OnNext the Subject, similar to how FromAsyncPattern
        // works.
        navigator.geolocation.getCurrentPosition( function(pos) {
            subject.onNext([pos.coords.latitude, pos.coords.longitude]);
            subject.onCompleted();
        }, function(err) {
            subject.onError(err.code);
        }, opts);

        return subject;
    };

    var mapChangeObservable = $('#mapOpts').onAsObservable('change').select(function (ev) {
        var opt = ev.currentTarget;
        return opt[opt.options.selectedIndex].value;
    }).startWith('roadmap');

    var currentMapUrl = mapChangeObservable.selectMany(function (mapType) {

        var mapPos = getCurrentPosition().catchException(Rx.Observable.returnValue([40.714728, -73.998672]));

        return mapPos.select(function (pos) {
            return [mapType, pos];
        });

    }).select(function (typeAndPos) {
        var mapType = typeAndPos[0], coords = typeAndPos[1];

        // Our selector will return the URL of the Google Static Maps image
        return "http://maps.googleapis.com/maps/api/staticmap?zoom=12&size=400x400&sensor=true"
                + "&maptype=" + mapType
                + "&center=" + coords[0] + "," + coords[1];
    });

    currentMapUrl.subscribe(function (url) {
        $("#mapImage").attr("src", url);
    });


    // 使用RxJS来隔离你的状态
//    var button = document.querySelector('button');
//    Rx.Observable.fromEvent(button, 'click')
//            .scan(count => count + 1, 0)
//    .subscribe(count => console.log(`Clicked ${count} times`));

//    每秒最多只能点击一次的实现
//    var button = document.querySelector('button');
//    Rx.Observable.fromEvent(button, 'click')
//            .throttleTime(1000)
//            .scan(count => count + 1, 0)
//    .subscribe(count => console.log(`Clicked ${count} times`));

    // 可观察者 不断的的推送消息 4个
//    var observable = Rx.Observable.create(function (observer) {
//        observer.next(1);
//        observer.next(2);
//        observer.next(3);
//        setTimeout(() => {
//            observer.next(4);
//        observer.complete();
//    }, 1000);
//    });
    //订阅者 不断的接受消息 并且处理消息
//    console.log('just before subscribe');
//    observable.subscribe({
//                next: x => console.log('got value ' + x),
//            error: err => console.error('something wrong occurred: ' + err),
//            complete: () => console.log('done'),
//    });
//    console.log('just after subscribe');
    //result
//    just before subscribe
//    got value 1
//    got value 2
//    got value 3
//    just after subscribe
//    got value 4
//    done

//    function foo() {
//        console.log('Hello');
//        return 42;
//        return 100; // dead code. will never happen
//    }
//    var foo = Rx.Observable.create(function (observer) {
//        console.log('Hello');
//        observer.next(42);
//        observer.next(100); // "return" another value
//        observer.next(200); // "return" yet another
//    });
//    console.log('before');
//    foo.subscribe(function (x) {
//        console.log(x);
//    });
//    console.log('after');
//    "before"
//    "Hello"
//    42
//    100
//    200
//    "after"


    var getOffset = function(event) {
        return {
            offsetX: event.offsetX === undefined ? event.layerX : event.offsetX,
            offsetY: event.offsetY === undefined ? event.layerY : event.offsetY
        };
    };

    var canvas = document.getElementById('tutorial');
    if (canvas.getContext) {
        var ctx = canvas.getContext('2d');
        ctx.beginPath();

        var cv = $('#tutorial');

        // Calculate mouse deltas
        var mouseMoves = cv.onAsObservable('mousemove'),
                mouseDiffs = mouseMoves.bufferWithCount(2, 1).select(function(x) {
                    return {
                        first: getOffset(x[0]),
                        second: getOffset(x[1])
                    };
                })

                // Merge mouse down and mouse up
                ,
                mouseButton = cv.onAsObservable('mousedown').select(function(x) {
                    return true;
                }).merge(cv.onAsObservable('mouseup').select(function(x) {
                    return false;
                }))

                // Determine whether to paint or lift
                ,
                paint = mouseButton.select(function(down) {
                    return down ? mouseDiffs : mouseDiffs.take(0)
                }).switchLatest();

        // Paint the results
        paint.subscribe(function(x) {
            ctx.moveTo(x.first.offsetX, x.first.offsetY);
            ctx.lineTo(x.second.offsetX, x.second.offsetY);
            ctx.stroke();
        });
    }

</script>

</html>